name: Java CI with Maven and SonarQube

on:
  push:
    branches: [ main, master, 'branch#1', 'Branch1/UserInterface' ]
  pull_request:
    branches: [ main, master, 'branch#1', 'Branch1/UserInterface' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper SCM analysis

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn -B clean compile --file pom.xml -Djava.awt.headless=true
        

      - name: Run Tests
        run: mvn -B test --file pom.xml -Djava.awt.headless=true

      - name: Run SonarQube Analysis
        continue-on-error: true
        run: |
          echo "Starting SonarQube analysis..."
          mvn sonar:sonar \
            -Dsonar.projectKey=Task8 \
            -Dsonar.projectName=Task8 \
            -Dsonar.host.url=https://dignified-hingeless-ehtel.ngrok-free.dev \
            -Dsonar.token=sqa_5d510ca2918143d3c6fc853fe840bc21c592a559 \
            -Dsonar.sources=src/main/java \
            -Dsonar.tests=src/test/java \
            -Dsonar.java.source=17 \
            -Dsonar.java.target=17 \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.scm.provider=git \
            -Dsonar.qualitygate.wait=false
          SONAR_EXIT_CODE=$?
          if [ $SONAR_EXIT_CODE -eq 0 ]; then
            echo "SonarQube analysis completed successfully!"
          else
            echo "SonarQube analysis failed with exit code: $SONAR_EXIT_CODE"
            echo "Check the logs above for details"
          fi
          exit $SONAR_EXIT_CODE
        id: sonar
      
      - name: SonarQube Analysis Status
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "SonarQube Analysis Status"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          if [ "${{ steps.sonar.outcome }}" == "failure" ]; then
            echo "❌ SonarQube analysis failed"
            echo ""
            echo "Possible reasons:"
            echo "  1. SonarQube server is not accessible"
            echo "  2. Invalid or expired token"
            echo "  3. Network connectivity issues"
            echo "  4. SonarQube server configuration issues"
            echo ""
            echo "Check the SonarQube step logs above for detailed error messages"
            echo "Verify:"
            echo "  - SonarQube URL is correct: https://dignified-hingeless-ehtel.ngrok-free.dev"
            echo "  - Token is valid and has proper permissions"
            echo "  - SonarQube server is running and accessible"
          elif [ "${{ steps.sonar.outcome }}" == "success" ]; then
            echo "✅ SonarQube analysis completed successfully!"
            echo ""
            echo "View results at:"
            echo "  https://dignified-hingeless-ehtel.ngrok-free.dev/dashboard?id=Task8"
          else
            echo "⚠️  SonarQube analysis status: ${{ steps.sonar.outcome }}"
          fi
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Trigger Jenkins Pipeline
        if: always()
        continue-on-error: true
        run: |
          echo "Triggering Jenkins pipeline..."
          
          # Hardcoded Jenkins configuration - Update these values for your Jenkins instance
          JENKINS_URL="https://060e6e0caaea.ngrok-free.app"  # Change to your Jenkins URL
          JENKINS_USER="brice"                  # Change to your Jenkins username
          JENKINS_TOKEN="110ab4bdced5725271e4cf91208945d4b6"   # Change to your Jenkins API token
          JENKINS_JOB_NAME="TaskEight"             # Change to your Jenkins job name
          
          # Set default job name if not provided
          JOB_NAME="${JENKINS_JOB_NAME:-Task8}"
          
          # Trigger Jenkins job
          # Get CSRF crumb if available
          CRUMB=$(curl -s -u "$JENKINS_USER:$JENKINS_TOKEN" "$JENKINS_URL/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)" 2>/dev/null || echo "")
          
          if [ -z "$CRUMB" ]; then
            echo "CSRF protection not enabled or crumb not available, proceeding without crumb"
          fi
          
          # Try to trigger the job (standard build)
          if [ -n "$CRUMB" ]; then
            HTTP_CODE=$(curl -s -X POST -u "$JENKINS_USER:$JENKINS_TOKEN" \
              -H "$CRUMB" \
              "$JENKINS_URL/job/$JOB_NAME/build" \
              -w "%{http_code}" -o /dev/null)
          else
            HTTP_CODE=$(curl -s -X POST -u "$JENKINS_USER:$JENKINS_TOKEN" \
              "$JENKINS_URL/job/$JOB_NAME/build" \
              -w "%{http_code}" -o /dev/null)
          fi
          
          # If standard build fails, try buildWithParameters (for parameterized jobs)
          if [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "200" ]; then
            echo "Standard build failed (HTTP $HTTP_CODE), trying buildWithParameters..."
            if [ -n "$CRUMB" ]; then
              HTTP_CODE=$(curl -s -X POST -u "$JENKINS_USER:$JENKINS_TOKEN" \
                -H "$CRUMB" \
                "$JENKINS_URL/job/$JOB_NAME/buildWithParameters" \
                -w "%{http_code}" -o /dev/null)
            else
              HTTP_CODE=$(curl -s -X POST -u "$JENKINS_USER:$JENKINS_TOKEN" \
                "$JENKINS_URL/job/$JOB_NAME/buildWithParameters" \
                -w "%{http_code}" -o /dev/null)
            fi
          fi
          
          if [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "200" ]; then
            echo "Failed to trigger Jenkins job. HTTP Status: $HTTP_CODE"
            echo "Please verify:"
            echo "  1. Jenkins URL is correct: $JENKINS_URL"
            echo "  2. Job name is correct: $JOB_NAME"
            echo "  3. User has permission to trigger builds"
            echo "  4. API token is valid"
            exit 1
          fi
          
          echo "Jenkins job triggered successfully"
          echo "Waiting for Jenkins build to complete..."
          
          # Get queue item
          QUEUE_ITEM=$(curl -s -u "$JENKINS_USER:$JENKINS_TOKEN" \
            "$JENKINS_URL/queue/api/json" | \
            jq -r ".items[] | select(.task.name==\"$JOB_NAME\") | .id" | head -1)
          
          # Wait for build to start
          BUILD_NUMBER=""
          MAX_WAIT=60
          WAIT_COUNT=0
          
          while [ -z "$BUILD_NUMBER" ] && [ $WAIT_COUNT -lt $MAX_WAIT ]; do
            sleep 2
            BUILD_NUMBER=$(curl -s -u "$JENKINS_USER:$JENKINS_TOKEN" \
              "$JENKINS_URL/job/$JOB_NAME/lastBuild/api/json" | \
              jq -r ".number // empty")
            WAIT_COUNT=$((WAIT_COUNT + 2))
            echo "Waiting for build to start... ($WAIT_COUNT/$MAX_WAIT seconds)"
          done
          
          if [ -z "$BUILD_NUMBER" ]; then
            echo "Could not determine build number. Check Jenkins dashboard manually."
            exit 0
          fi
          
          echo "Jenkins build #$BUILD_NUMBER started"
          BUILD_URL="$JENKINS_URL/job/$JOB_NAME/$BUILD_NUMBER"
          echo "Build URL: $BUILD_URL"
          
          # Poll for build completion
          MAX_POLL=1800  # 30 minutes
          POLL_COUNT=0
          BUILD_STATUS=""
          
          while [ "$BUILD_STATUS" != "SUCCESS" ] && [ "$BUILD_STATUS" != "FAILURE" ] && [ "$BUILD_STATUS" != "ABORTED" ] && [ $POLL_COUNT -lt $MAX_POLL ]; do
            sleep 5
            BUILD_STATUS=$(curl -s -u "$JENKINS_USER:$JENKINS_TOKEN" \
              "$BUILD_URL/api/json" | \
              jq -r ".result // \"BUILDING\"")
            
            if [ "$BUILD_STATUS" == "BUILDING" ] || [ -z "$BUILD_STATUS" ]; then
              POLL_COUNT=$((POLL_COUNT + 5))
              if [ $((POLL_COUNT % 30)) -eq 0 ]; then
                echo "Build still running... ($POLL_COUNT/$MAX_POLL seconds)"
              fi
            fi
          done
          
          # Get final build status and console output
          FINAL_STATUS=$(curl -s -u "$JENKINS_USER:$JENKINS_TOKEN" \
            "$BUILD_URL/api/json" | \
            jq -r ".result // \"UNKNOWN\"")
          
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Jenkins Pipeline Results"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Build Number: #$BUILD_NUMBER"
          echo "Status: $FINAL_STATUS"
          echo "Build URL: $BUILD_URL"
          echo ""
          
          # Display console output (last 100 lines)
          echo "Console Output (last 100 lines):"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          curl -s -u "$JENKINS_USER:$JENKINS_TOKEN" \
            "$BUILD_URL/consoleText" | tail -100
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          if [ "$FINAL_STATUS" == "SUCCESS" ]; then
            echo "Jenkins pipeline completed successfully!"
          elif [ "$FINAL_STATUS" == "FAILURE" ]; then
            echo "Jenkins pipeline failed!"
            exit 1
          elif [ "$FINAL_STATUS" == "ABORTED" ]; then
            echo "Jenkins pipeline was aborted!"
            exit 1
          else
            echo "Jenkins pipeline status unknown or timed out"
            echo "Check Jenkins dashboard for details: $BUILD_URL"
          fi
        id: jenkins

